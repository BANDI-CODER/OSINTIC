import logging
import sqlite3
import re
import time
import os
import shutil
from datetime import datetime, timedelta
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    Updater,
    CommandHandler,
    MessageHandler,
    Filters,
    CallbackContext,
    ConversationHandler
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = "7718428534:AAF9EVtiIU53lQQ87If4kS92qWFpc88Hyjw"
ADMIN_CHAT_ID = 5157370467
DB_NAME = "user_data.db"
BACKUP_DIR = "backups"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
os.makedirs(BACKUP_DIR, exist_ok=True)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
MAIN_MENU, ADMIN_MENU, WAITING_FOR_ID, WAITING_FOR_MESSAGE = range(4)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    filename='bot.log',
    filemode='a'
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    c.execute('''CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER UNIQUE,
                first_name TEXT,
                last_name TEXT,
                username TEXT,
                language_code TEXT,
                profile_link TEXT,
                registration_date TEXT,
                last_activity TEXT,
                message_count INTEGER DEFAULT 0,
                is_banned BOOLEAN DEFAULT 0
                )''')
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    c.execute('''CREATE TABLE IF NOT EXISTS messages (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                message_text TEXT,
                timestamp TEXT,
                FOREIGN KEY(user_id) REFERENCES users(user_id)
                ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –∞–¥–º–∏–Ω–æ–≤
    c.execute('''CREATE TABLE IF NOT EXISTS admins (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                admin_id INTEGER UNIQUE,
                username TEXT,
                added_date TEXT
                )''')
    
    # –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ç–∞–±–ª–∏—Ü–∞ –±–∞–Ω–æ–≤
    c.execute('''CREATE TABLE IF NOT EXISTS bans (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                admin_id INTEGER,
                reason TEXT,
                timestamp TEXT,
                FOREIGN KEY(user_id) REFERENCES users(user_id),
                FOREIGN KEY(admin_id) REFERENCES admins(admin_id)
                ''')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    c.execute("INSERT OR IGNORE INTO admins (admin_id, username, added_date) VALUES (?, ?, ?)",
              (ADMIN_CHAT_ID, "admin", now))
    
    conn.commit()
    conn.close()

init_db()

# ======================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ======================

def get_db_connection():
    return sqlite3.connect(DB_NAME)

def log_user_activity(user_id, message_text=None):
    conn = get_db_connection()
    c = conn.cursor()
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    c.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = c.fetchone()
    
    if user:
        c.execute("UPDATE users SET last_activity = ?, message_count = message_count + 1 WHERE user_id = ?", 
                 (now, user_id))
    else:
        c.execute("INSERT INTO users (user_id, last_activity) VALUES (?, ?)", 
                 (user_id, now))
    
    if message_text:
        c.execute("INSERT INTO messages (user_id, message_text, timestamp) VALUES (?, ?, ?)",
                 (user_id, message_text, now))
    
    conn.commit()
    conn.close()

def get_user_info(user_id):
    conn = get_db_connection()
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    columns = [col[0] for col in c.description] if c.description else []
    user = c.fetchone()
    conn.close()
    
    if user and columns:
        return dict(zip(columns, user))
    return None

def is_admin(user_id):
    conn = get_db_connection()
    c = conn.cursor()
    c.execute("SELECT * FROM admins WHERE admin_id = ?", (user_id,))
    admin = c.fetchone()
    conn.close()
    return admin is not None

def save_full_user_info(user):
    conn = get_db_connection()
    c = conn.cursor()
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    profile_link = f"tg://user?id={user.id}"
    
    c.execute('''INSERT OR IGNORE INTO users 
              (user_id, first_name, last_name, username, language_code, profile_link, registration_date, last_activity) 
              VALUES (?, ?, ?, ?, ?, ?, ?, ?)''',
              (user.id, user.first_name or "", user.last_name or "", user.username or "", 
               user.language_code or "", profile_link, now, now))
    
    c.execute('''UPDATE users SET 
              first_name = ?, 
              last_name = ?, 
              username = ?, 
              language_code = ?, 
              profile_link = ?,
              last_activity = ?
              WHERE user_id = ?''',
              (user.first_name or "", user.last_name or "", user.username or "", 
               user.language_code or "", profile_link, now, user.id))
    
    conn.commit()
    conn.close()

def get_user_stats():
    stats = {
        "total_users": 0,
        "active_users": 0,
        "banned_users": 0,
        "total_messages": 0
    }
    
    try:
        conn = get_db_connection()
        c = conn.cursor()
        
        c.execute("SELECT COUNT(*) FROM users")
        stats["total_users"] = c.fetchone()[0] or 0
        
        week_ago = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d %H:%M:%S")
        c.execute("SELECT COUNT(*) FROM users WHERE last_activity > ?", (week_ago,))
        stats["active_users"] = c.fetchone()[0] or 0
        
        c.execute("SELECT COUNT(*) FROM users WHERE is_banned = 1")
        stats["banned_users"] = c.fetchone()[0] or 0
        
        c.execute("SELECT COUNT(*) FROM messages")
        stats["total_messages"] = c.fetchone()[0] or 0
        
    except sqlite3.Error as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
    finally:
        conn.close()
    
    return stats

def create_backup():
    """–°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    try:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_path = os.path.join(BACKUP_DIR, f"backup_{timestamp}.db")
        shutil.copyfile(DB_NAME, backup_path)
        return backup_path
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: {e}")
        return None

# ======================
# –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ë–û–¢–ê
# ======================

def start(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    save_full_user_info(user)
    
    if is_admin(user.id):
        keyboard = [
            ['üîç –ü—Ä–æ–±–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å'],
            ['üëÆ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', '‚ÑπÔ∏è –û –±–æ—Ç–µ']
        ]
    else:
        keyboard = [
            ['üîç –ü—Ä–æ–±–∏—Ç—å —Å–µ–±—è', 'üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å'],
            ['‚ÑπÔ∏è –û –±–æ—Ç–µ']
        ]
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    update.message.reply_text(
        f"üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!\n"
        "–Ø - –º–æ—â–Ω—ã–π –±–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )
    return MAIN_MENU

def about_bot(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    
    update.message.reply_text(
        "ü§ñ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä PRO</b>\n\n"
        "–í–µ—Ä—Å–∏—è: 3.1\n"
        "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: Security Systems\n"
        "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n"
        "- –°–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö\n"
        "- –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n"
        "- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
        "- –°–∏—Å—Ç–µ–º–∞ –±–∞–Ω–æ–≤ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ—Ç–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ!",
        parse_mode='HTML'
    )
    return MAIN_MENU

def my_profile(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    user_info = get_user_info(user.id)
    
    if user_info:
        status = "üü¢ –ê–∫—Ç–∏–≤–µ–Ω" if not user_info.get('is_banned', 0) else "üî¥ –ó–∞–±–∞–Ω–µ–Ω"
        
        response = (
            f"üë§ <b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</b>\n\n"
            f"üÜî ID: <code>{user_info.get('user_id', 'N/A')}</code>\n"
            f"üë§ –ò–º—è: {user_info.get('first_name', '‚ùå')}\n"
            f"üë• –§–∞–º–∏–ª–∏—è: {user_info.get('last_name', '‚ùå')}\n"
            f"üåê Username: @{user_info.get('username', '‚ùå')}\n"
            f"üåç –Ø–∑—ã–∫: {user_info.get('language_code', '‚ùå')}\n"
            f"üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {user_info.get('registration_date', '‚ùå')}\n"
            f"üïí –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {user_info.get('last_activity', '‚ùå')}\n"
            f"‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–π: {user_info.get('message_count', 0)}\n"
            f"üîí –°—Ç–∞—Ç—É—Å: {status}\n"
            f"üîó –ü—Ä–æ—Ñ–∏–ª—å: {user_info.get('profile_link', '‚ùå')}"
        )
    else:
        response = "‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—Å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."
    
    update.message.reply_text(response, parse_mode='HTML')
    return MAIN_MENU

def probe_user(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    
    if is_admin(user.id):
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:")
        return WAITING_FOR_ID
    else:
        return show_user_profile(update, context, user.id)

def show_user_profile(update: Update, context: CallbackContext, target_user_id: int) -> int:
    user_info = get_user_info(target_user_id)
    
    if user_info:
        status = "üü¢ –ê–∫—Ç–∏–≤–µ–Ω" if not user_info.get('is_banned', 0) else "üî¥ –ó–∞–±–∞–Ω–µ–Ω"
        admin_actions = ""
        
        if is_admin(update.effective_user.id):
            if user_info.get('is_banned', 0):
                admin_actions = f"\n\nüîì <b>–ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è:</b>\n/unban_{user_info['user_id']} - –†–∞–∑–±–∞–Ω–∏—Ç—å"
            else:
                admin_actions = f"\n\nüîí <b>–ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è:</b>\n/ban_{user_info['user_id']} - –ó–∞–±–∞–Ω–∏—Ç—å"
        
        response = (
            f"üîç <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</b>\n\n"
            f"üÜî ID: <code>{user_info.get('user_id', 'N/A')}</code>\n"
            f"üë§ –ò–º—è: {user_info.get('first_name', '‚ùå')}\n"
            f"üë• –§–∞–º–∏–ª–∏—è: {user_info.get('last_name', '‚ùå')}\n"
            f"üåê Username: @{user_info.get('username', '‚ùå')}\n"
            f"üåç –Ø–∑—ã–∫: {user_info.get('language_code', '‚ùå')}\n"
            f"üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {user_info.get('registration_date', '‚ùå')}\n"
            f"üïí –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {user_info.get('last_activity', '‚ùå')}\n"
            f"‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–π: {user_info.get('message_count', 0)}\n"
            f"üîí –°—Ç–∞—Ç—É—Å: {status}\n"
            f"üîó –ü—Ä–æ—Ñ–∏–ª—å: {user_info.get('profile_link', '‚ùå')}"
            f"{admin_actions}"
        )
    else:
        response = "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."
    
    update.message.reply_text(response, parse_mode='HTML')
    return MAIN_MENU if not is_admin(update.effective_user.id) else ADMIN_MENU

def handle_user_id(update: Update, context: CallbackContext) -> int:
    user_input = update.message.text
    log_user_activity(update.effective_user.id)
    
    if user_input.isdigit():
        return show_user_profile(update, context, int(user_input))
    else:
        update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return WAITING_FOR_ID

def admin_panel(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    
    if not is_admin(user.id):
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏!")
        return MAIN_MENU
    
    keyboard = [
        ['üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'üì¢ –†–∞—Å—Å—ã–ª–∫–∞'],
        ['üîÑ –ë—ç–∫–∞–ø –±–∞–∑—ã'],
        ['üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é']
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    update.message.reply_text("üëÆ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", 
                             reply_markup=reply_markup, parse_mode='HTML')
    return ADMIN_MENU

def show_stats(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    
    if not is_admin(user.id):
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞!")
        return MAIN_MENU
    
    stats = get_user_stats()
    
    try:
        conn = get_db_connection()
        c = conn.cursor()
        c.execute("SELECT user_id, first_name, message_count FROM users ORDER BY message_count DESC LIMIT 5")
        top_users = c.fetchall()
        top_users_text = "\n".join(
            [f"{idx+1}. {user[1] or 'Unknown'}: {user[2]} —Å–æ–æ–±—â." for idx, user in enumerate(top_users)]
        )
    except sqlite3.Error as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        top_users_text = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
    finally:
        conn.close()
    
    response = (
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:</b>\n\n"
        f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
        f"üü¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö (7 –¥–Ω–µ–π): {stats['active_users']}\n"
        f"üî¥ –ó–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö: {stats['banned_users']}\n"
        f"‚úâÔ∏è –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {stats['total_messages']}\n\n"
        f"üèÜ <b>–¢–æ–ø-5 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b>\n{top_users_text}"
    )
    
    update.message.reply_text(response, parse_mode='HTML')
    return ADMIN_MENU

def broadcast_message(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    
    if not is_admin(user.id):
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞!")
        return MAIN_MENU
    
    update.message.reply_text("‚úâÔ∏è –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:")
    return WAITING_FOR_MESSAGE

def send_broadcast(update: Update, context: CallbackContext) -> int:
    message_text = update.message.text
    admin_id = update.effective_user.id
    
    conn = get_db_connection()
    c = conn.cursor()
    try:
        c.execute("SELECT user_id FROM users WHERE is_banned = 0")
        users = c.fetchall()
    except sqlite3.Error as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
        users = []
    finally:
        conn.close()
    
    total_users = len(users)
    success_count = 0
    fail_count = 0
    
    for user in users:
        try:
            context.bot.send_message(chat_id=user[0], text=message_text)
            success_count += 1
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–ª—è {user[0]}: {e}")
            fail_count += 1
        time.sleep(0.1)
    
    report = (
        f"üì¢ <b>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—Å—ã–ª–∫–∏:</b>\n\n"
        f"‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ: {message_text}\n"
        f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n"
        f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {success_count}\n"
        f"‚ùå –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {fail_count}"
    )
    
    context.bot.send_message(chat_id=admin_id, text=report, parse_mode='HTML')
    return admin_panel(update, context)

def ban_user(update: Update, context: CallbackContext) -> None:
    user = update.effective_user
    command = update.message.text
    
    if not is_admin(user.id):
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞!")
        return
    
    match = re.search(r'/ban_(\d+)', command)
    if match:
        target_user_id = int(match.group(1))
        
        conn = get_db_connection()
        c = conn.cursor()
        try:
            c.execute("SELECT is_banned FROM users WHERE user_id = ?", (target_user_id,))
            result = c.fetchone()
            
            if result and result[0] == 1:
                update.message.reply_text(f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user_id} —É–∂–µ –∑–∞–±–∞–Ω–µ–Ω.")
                return
            
            c.execute("UPDATE users SET is_banned = 1 WHERE user_id = ?", (target_user_id,))
            
            now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            c.execute("INSERT INTO bans (user_id, admin_id, reason, timestamp) VALUES (?, ?, ?, ?)",
                     (target_user_id, user.id, "–ö–æ–º–∞–Ω–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", now))
            
            conn.commit()
            update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–±–∞–Ω–µ–Ω.")
            
            try:
                context.bot.send_message(
                    chat_id=target_user_id,
                    text="‚õî –í—ã –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–º –±–æ—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
                )
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id} –æ –±–∞–Ω–µ: {e}")
        except sqlite3.Error as e:
            logger.error(f"–û—à–∏–±–∫–∞ –±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏")
        finally:
            conn.close()
    else:
        update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ban_123456789")

def unban_user(update: Update, context: CallbackContext) -> None:
    user = update.effective_user
    command = update.message.text
    
    if not is_admin(user.id):
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞!")
        return
    
    match = re.search(r'/unban_(\d+)', command)
    if match:
        target_user_id = int(match.group(1))
        
        conn = get_db_connection()
        c = conn.cursor()
        try:
            c.execute("SELECT is_banned FROM users WHERE user_id = ?", (target_user_id,))
            result = c.fetchone()
            
            if result and result[0] == 0:
                update.message.reply_text(f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user_id} –Ω–µ –∑–∞–±–∞–Ω–µ–Ω.")
                return
            
            c.execute("UPDATE users SET is_banned = 0 WHERE user_id = ?", (target_user_id,))
            conn.commit()
            update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user_id} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–∞–Ω–µ–Ω.")
            
            try:
                context.bot.send_message(
                    chat_id=target_user_id,
                    text="‚úÖ –í–∞—à–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ —ç—Ç–æ–º –±–æ—Ç–µ –±—ã–ª–∞ —Å–Ω—è—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
                )
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id} –æ —Ä–∞–∑–±–∞–Ω–µ: {e}")
        except sqlite3.Error as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞–∑–±–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏")
        finally:
            conn.close()
    else:
        update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /unban_123456789")

def backup_database(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    log_user_activity(user.id)
    
    if not is_admin(user.id):
        update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞!")
        return ADMIN_MENU
    
    try:
        backup_path = create_backup()
        if backup_path:
            context.bot.send_document(
                chat_id=user.id,
                document=open(backup_path, 'rb'),
                filename=os.path.basename(backup_path)
            )
            update.message.reply_text("‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞.")
        else:
            update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏!")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: {e}")
        update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏!")
    return ADMIN_MENU

def handle_message(update: Update, context: CallbackContext) -> int:
    user = update.effective_user
    text = update.message.text
    log_user_activity(user.id, text)
    save_full_user_info(user)
    
    update.message.reply_text(
        "ü§ñ –Ø –Ω–µ –ø–æ–Ω—è–ª –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é "
        "–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."
    )
    return MAIN_MENU

# ======================
# –ó–ê–ü–£–°–ö –ë–û–¢–ê
# ======================

def main():
    # –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø
    create_backup()
    
    updater = Updater(BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            MAIN_MENU: [
                MessageHandler(Filters.regex('^üîç –ü—Ä–æ–±–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è$'), probe_user),
                MessageHandler(Filters.regex('^üîç –ü—Ä–æ–±–∏—Ç—å —Å–µ–±—è$'), probe_user),
                MessageHandler(Filters.regex('^üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å$'), my_profile),
                MessageHandler(Filters.regex('^‚ÑπÔ∏è –û –±–æ—Ç–µ$'), about_bot),
                MessageHandler(Filters.regex('^üëÆ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å$'), admin_panel)
            ],
            ADMIN_MENU: [
                MessageHandler(Filters.regex('^üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞$'), show_stats),
                MessageHandler(Filters.regex('^üì¢ –†–∞—Å—Å—ã–ª–∫–∞$'), broadcast_message),
                MessageHandler(Filters.regex('^üîÑ –ë—ç–∫–∞–ø –±–∞–∑—ã$'), backup_database),
                MessageHandler(Filters.regex('^üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é$'), start)
            ],
            WAITING_FOR_ID: [
                MessageHandler(Filters.text & ~Filters.command, handle_user_id)
            ],
            WAITING_FOR_MESSAGE: [
                MessageHandler(Filters.text & ~Filters.command, send_broadcast)
            ]
        },
        fallbacks=[CommandHandler('start', start)],
    )

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    dp.add_handler(conv_handler)
    dp.add_handler(MessageHandler(Filters.regex(r'^/ban_\d+$'), ban_user))
    dp.add_handler(MessageHandler(Filters.regex(r'^/unban_\d+$'), unban_user))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    updater.start_polling()
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç...")
    updater.idle()

if __name__ == '__main__':
    main()
